{% extends "layout.html" %}
{% block title %}Setup Two-Factor Authentication{% endblock %}

{% block body %}
<section class="text-gray-300 bg-gray-900 body-font min-h-screen flex items-center justify-center totp-setup">
  <div class="container px-5 py-12 mx-auto flex flex-wrap items-center justify-between gap-10">

    <!-- Left side: QR -->
    <div class="lg:w-3/5 md:w-1/2 md:pr-16 lg:pr-0 relative flex justify-center">
      <div
        class="relative bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-8 shadow-xl border border-indigo-500/30 hover:border-indigo-500/50 transition-all duration-300 w-full max-w-lg">
        <h1 class="title-font font-semibold text-2xl text-white mb-4 tracking-wider text-center">
          Enable Two-Factor Authentication
        </h1>

        <div class="flex flex-col items-center">
          <!-- QR Code -->
          <div id="qrcode-container"
            class="mt-4 p-4 bg-gray-800/50 rounded-xl shadow-inner border border-gray-700/50 transition-transform duration-300 hover:scale-105">
            <img id="qrcode" alt="TOTP QR Code"
              class="w-36 h-36 max-w-full sm:w-56 sm:h-56 md:w-60 md:h-60 lg:w-64 lg:h-64 rounded-md object-contain"
              src="data:image/png;base64,{{ qr_code }}" />
          </div>
        </div>

        <!-- Background glow -->
        <div class="absolute inset-0 -z-10 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 opacity-50 blur-2xl">
        </div>
      </div>
    </div>

    <!-- Right side: Verification form -->
    <div
      class="lg:w-2/6 md:w-1/2 bg-gray-800 bg-opacity-50 rounded-2xl p-8 flex flex-col md:ml-auto w-full mt-10 md:mt-0 shadow-lg border border-gray-700/50 max-w-md mx-auto">
      <h2 class="text-white text-lg font-medium title-font mb-5 text-center">Verify Your Code</h2>

      <form id="totpForm" autocomplete="off">
        <div class="relative mb-4">
          <label class="leading-7 text-sm text-gray-400 mb-3 block text-center">
            Enter the 6-digit code from your authenticator app
          </label>
          <div class="flex justify-center gap-3 mb-4 overflow-x-auto whitespace-nowrap">
            {% for i in range(6) %}
            <input type="text" inputmode="numeric" maxlength="1" autocomplete="off" pattern="[0-9]*"
              class="otp-input w-10 h-12 bg-gray-700 focus:bg-transparent focus:ring-2 focus:ring-indigo-900
                rounded-lg border border-gray-600 focus:border-indigo-500 text-base outline-none text-gray-100
                text-center text-xl font-semibold transition-all duration-150 ease-in-out flex-shrink-0"
              data-index="{{ i }}" aria-label="Digit {{ i + 1 }}" />
            {% endfor %}
          </div>
          <input type="hidden" id="totp" name="totp" />
        </div>

        <button type="submit" class="text-white bg-indigo-500 border-0 py-2 px-8 focus:outline-none hover:bg-indigo-600
                       rounded-lg text-lg transition-all duration-200 ease-in-out w-full">
          Verify
        </button>
        <p id="error-msg" class="text-red-500 text-sm mt-3 hidden text-center"></p>
      </form>
    </div>
  </div>
</section>

<!-- JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const otpInputs = document.querySelectorAll(".otp-input");
    const hiddenInput = document.getElementById("totp");
    const form = document.getElementById("totpForm");
    const errorMsg = document.getElementById("error-msg");

    // Handle OTP input navigation and paste
    otpInputs.forEach((input, i) => {
      input.addEventListener("input", (e) => {
        e.target.value = e.target.value.replace(/\D/g, "");
        if (e.target.value && i < otpInputs.length - 1) otpInputs[i + 1].focus();
        updateHidden();
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !input.value && i > 0) otpInputs[i - 1].focus();
      });

      // Handle pasting full OTP
      input.addEventListener("paste", (e) => {
        e.preventDefault();
        const pasteData = (e.clipboardData || window.clipboardData).getData("text").replace(/\D/g, "");
        if (!pasteData) return;
        for (let j = 0; j < otpInputs.length; j++) {
          otpInputs[j].value = pasteData[j] || "";
        }
        updateHidden();
      });
    });

    // Update hidden input
    function updateHidden() {
      hiddenInput.value = Array.from(otpInputs).map(i => i.value).join("");
    }

    // Show error/success messages
    function showError(msg, success = false) {
      errorMsg.textContent = msg;
      errorMsg.classList.remove("hidden", "text-green-400", "text-red-500");
      errorMsg.classList.add(success ? "text-green-400" : "text-red-500");
    }

    // Form submission
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      updateHidden();
      const code = hiddenInput.value.trim();
      if (code.length !== 6) return showError("Please enter all 6 digits of the TOTP code!");

      try {
        const res = await fetch("/login/totp/setup", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-Requested-With": "XMLHttpRequest",
          },
          body: new URLSearchParams({ totp: code }),
        });
        const data = await res.json();
        if (data.status === "success") {
          showError(data.message || "Verified successfully! Redirecting...", true);
          setTimeout(() => (window.location.href = data.redirect), 1000);
        } else {
          showError(data.message || "Invalid TOTP code!");
        }
      } catch {
        showError("An unexpected error occurred. Please try again.");
      }
    });

    otpInputs[0].focus();
  });
</script>
{% endblock %}