{% extends "layout.html" %}
{% block title %}Setup Two-Factor Authentication{% endblock %}

{% block body %}
<section class="text-gray-300 bg-gray-900 body-font min-h-screen flex items-center justify-center totp-setup">
  <div class="container px-5 py-12 mx-auto flex flex-wrap items-center justify-between">

    <!-- Left side: QR + Secret -->
    <div class="lg:w-3/5 md:w-1/2 md:pr-16 lg:pr-0 relative">
      <div
        class="relative bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-8 shadow-xl border border-indigo-500/30 hover:border-indigo-500/50 transition-all duration-300">
        <h1 class="title-font font-semibold text-2xl text-white mb-4 tracking-wider">
          Enable Two-Factor Authentication
        </h1>
        <div class="flex flex-col items-center">
          <!-- QR Code -->
          <div id="qrcode-container"
            class="mt-4 p-4 bg-gray-800/50 rounded-lg shadow-inner border border-gray-700/50 transition-transform duration-300 hover:scale-105">
            <img id="qrcode" alt="TOTP QR Code" class="w-48 h-48 rounded-md" />
          </div>

          <!-- Manual Secret -->
          <div class="mt-4 text-center">
            <p class="text-sm text-gray-400">Or enter this code manually:</p>
            <div class="flex items-center justify-center gap-2 mt-1">
              <strong class="text-indigo-300 font-mono text-lg bg-gray-800/30 px-3 py-1 rounded-md select-all">
                {{ totp_secret }}
              </strong>
              <button id="copy-secret"
                class="text-indigo-400 hover:text-indigo-300 text-sm font-medium transition-colors duration-200 flex items-center gap-1"
                title="Copy Secret">
                <i class="fa-solid fa-copy"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Background glow -->
        <div class="absolute inset-0 -z-10 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 opacity-50 blur-2xl">
        </div>
      </div>
    </div>

    <!-- Right side: Verification form -->
    <div
      class="lg:w-2/6 md:w-1/2 bg-gray-800 bg-opacity-50 rounded-2xl p-8 flex flex-col md:ml-auto w-full mt-10 md:mt-0 shadow-lg border border-gray-700/50">
      <h2 class="text-white text-lg font-medium title-font mb-5">Verify Your Code</h2>

      <form id="totpForm">
        <div class="relative mb-4">
          <label class="leading-7 text-sm text-gray-400 mb-3 block">
            Enter the 6-digit code from your authenticator app
          </label>
          <div class="flex justify-center gap-4 mb-4">
            {% for i in range(6) %}
            <input type="text" inputmode="numeric" maxlength="1" autocomplete="off" pattern="[0-9]*" class="otp-input w-10 h-12 bg-gray-700 focus:bg-transparent focus:ring-2 focus:ring-indigo-900
                          rounded-lg border border-gray-600 focus:border-indigo-500 text-base outline-none text-gray-100
                          text-center text-xl font-semibold transition-all duration-150 ease-in-out"
              data-index="{{ i }}" />
            {% endfor %}
          </div>
          <input type="hidden" id="totp" name="totp" />
        </div>

        <button type="submit" class="text-white bg-indigo-500 border-0 py-2 px-8 focus:outline-none hover:bg-indigo-600
                       rounded-lg text-lg transition-all duration-200 ease-in-out w-full">
          Verify
        </button>
        <p id="error-msg" class="text-red-500 text-sm mt-3 hidden"></p>
      </form>
    </div>
  </div>
</section>

<!-- QR Code Generator -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const uri = {{ uri | tojson | safe }};
    const secret = "{{ totp_secret }}";
    const qrcodeEl = document.getElementById("qrcode");
    const errorMsg = document.getElementById("error-msg");
    const otpInputs = document.querySelectorAll(".otp-input");
    const hiddenInput = document.getElementById("totp");
    const form = document.getElementById("totpForm");

    // Generate QR code
    console.log("Generating QR code with URI:", uri);
    QRCode.toDataURL(uri, { width: 192, margin: 2 }, (err, url) => {
      if (err) {
        console.error("QR code generation failed:", err);
      } else {
        console.log("QR code generated successfully");
        qrcodeEl.src = url;
      }
    });

    // Copy secret
    document.getElementById("copy-secret").addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(secret);
        console.log("Secret copied to clipboard:", secret);
        const icon = document.querySelector("#copy-secret i");
        icon.classList.replace("fa-copy", "fa-check");
        setTimeout(() => icon.classList.replace("fa-check", "fa-copy"), 2000);
      } catch (err) {
        console.error("Clipboard copy failed:", err);
      }
    });

    // OTP inputs behavior
    otpInputs.forEach((input, i) => {
      input.addEventListener("input", (e) => {
        if (!/^\d?$/.test(e.target.value)) e.target.value = "";
        if (e.target.value && i < otpInputs.length - 1) otpInputs[i + 1].focus();
        updateHiddenInput();
        console.log("Current TOTP input:", hiddenInput.value);
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !input.value && i > 0) otpInputs[i - 1].focus();
      });

      input.addEventListener("paste", (e) => {
        e.preventDefault();
        const data = e.clipboardData.getData("text").trim();
        console.log("Pasted data:", data);
        if (/^\d{6}$/.test(data)) {
          data.split("").forEach((char, idx) => otpInputs[idx].value = char);
          otpInputs[5].focus();
          updateHiddenInput();
          console.log("TOTP after paste:", hiddenInput.value);
        }
      });
    });

    function updateHiddenInput() {
      hiddenInput.value = Array.from(otpInputs).map(i => i.value).join("");
    }

    // Form submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      updateHiddenInput();
      const code = hiddenInput.value.trim();
      console.log("Submitting TOTP code:", code);
      if (code.length !== 6) {
        console.log("TOTP code invalid: less than 6 digits");
        showError("Please enter all 6 digits of the TOTP code!");
        return;
      }

      try {
        console.log("Sending POST request to /login/totp/setup");
        const res = await fetch("/login/totp/setup", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-Requested-With": "XMLHttpRequest",
          },
          body: new URLSearchParams({ totp: code }),
        });
        console.log("Response status:", res.status);
        const data = await res.json();
        console.log("Server response:", data);
        handleServerResponse(data);
      } catch (err) {
        console.error("Error during fetch:", err);
        showError("An unexpected error occurred. Please try again.");
      }
    });

    function handleServerResponse(data) {
      console.log("Handling server response:", data);
      errorMsg.classList.remove("hidden", "text-green-400");

      if (data.status === "success") {
        console.log("TOTP verification successful, redirecting to:", data.redirect);
        errorMsg.classList.add("text-green-400");
        errorMsg.textContent = data.message || "Verified successfully! Redirecting...";
        otpInputs.forEach(i => i.value = "");
        setTimeout(() => window.location.href = data.redirect, 1000);
      } else if (data.status === "error") {
        console.log("TOTP verification failed:", data.message);
        showError(data.message || "Invalid TOTP code!");
        otpInputs.forEach(i => i.value = "");
        otpInputs[0].focus();
      } else if (data.status === "regen") {
        console.log("Too many failed attempts, regenerating:", data.message);
        showError(data.message || "Too many failed attempts. Regenerating...");
        setTimeout(() => window.location.reload(), 1500);
      } else {
        console.log("Unexpected server response status:", data.status);
        showError("Unexpected server response. Please try again.");
      }
    }

    function showError(msg) {
      console.log("Displaying error:", msg);
      errorMsg.textContent = msg;
      errorMsg.classList.remove("hidden", "text-green-400");
    }

    otpInputs[0].focus();
  });
</script>
{% endblock %}